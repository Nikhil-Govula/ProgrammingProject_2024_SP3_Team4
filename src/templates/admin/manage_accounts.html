{% extends "base.html" %}

{% block head %}
    <title>Manage Accounts</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Function to update the table
            function updateTable() {
                var accountType = $('#account_type').val();
                var accountStatus = $('#account_status').val();
                var searchQuery = $('#search_query').val();

                $.ajax({
                    url: "{{ url_for('admin_views.manage_accounts') }}",
                    data: {
                        account_type: accountType,
                        account_status: accountStatus,
                        search: searchQuery
                    },
                    success: function(data) {
                        $('#accounts-table-body').html($(data).find('#accounts-table-body').html());
                    }
                });
            }

            // Attach event listeners
            $('#account_type, #account_status').change(updateTable);
            $('#search_query').on('input', updateTable);

            // Set initial dropdown values
            var defaultAccountType = "{{ account_type }}" || "user";
            $('#account_type').val(defaultAccountType);
            $('#account_status').val("{{ account_status }}");
            $('#search_query').val("{{ search_query }}");

            // Trigger initial table update
            updateTable();
        });
    </script>
{% endblock %}

{% block body %}
<div class="container">
    <h2>Manage Accounts</h2>
    <div class="filter-form">
        <form id="filter-form">
            <label for="account_type">Account Type:</label>
            <select name="account_type" id="account_type">
                <option value="user" selected>User</option>
                <option value="employer">Employer</option>
                <option value="admin">Admin</option>
            </select>

            <label for="account_status">Account Status:</label>
            <select name="account_status" id="account_status">
                <option value="all">Show All</option>
                <option value="active">Only Active Accounts</option>
                <option value="locked">Show Locked Accounts</option>
            </select>

            <input type="text" name="search" id="search_query" placeholder="Search...">
        </form>
    </div>

    <table class="accounts-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Account Type</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="accounts-table-body">
    {% for account in accounts %}
        <tr>
            <td>
                {% if account.__class__.__name__ == 'Employer' %}
                    {{ account.company_name }}
                {% else %}
                    {{ account.first_name }} {{ account.last_name }}
                {% endif %}
            </td>
            <td>{{ account.email }}</td>
            <td>
                {% if account.__class__.__name__ == 'Admin' %}
                    Admin
                {% elif account.__class__.__name__ == 'Employer' %}
                    Employer
                {% elif account.__class__.__name__ == 'User' %}
                    User
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if account.is_active %}
                    Active
                {% elif account.account_locked %}
                    Locked
                {% else %}
                    Inactive
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('admin_views.account_detail', account_type='admin' if account.__class__.__name__ == 'Admin' else 'employer' if account.__class__.__name__ == 'Employer' else 'user', account_id=account.admin_id if account.__class__.__name__ == 'Admin' else account.employer_id if account.__class__.__name__ == 'Employer' else account.user_id) }}" class="btn">View/Edit</a>
            </td>
        </tr>
    {% endfor %}
</tbody>

    </table>
</div>
{% endblock %}