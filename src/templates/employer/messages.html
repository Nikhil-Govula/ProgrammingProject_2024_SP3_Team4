{% extends "base.html" %}

{% block head %}
<title>Messages - Employer Dashboard</title>
<style>
    .messages-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
    }

    .conversation-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .conversation-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
    }

    .conversation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .profile-picture {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }

    .conversation-info {
        flex-grow: 1;
    }

    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .user-name {
        font-weight: bold;
        font-size: 1.1em;
    }

    .job-title {
        color: #666;
        font-size: 0.9em;
        font-style: italic;
    }

    .timestamp {
        color: #666;
        font-size: 0.9em;
    }

    .latest-message {
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .unread-badge {
        background: #0073b1;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8em;
    }

    .no-conversations {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block body %}
<div class="messages-container">
    <h2>Messages</h2>

    {% if conversations %}
        <div class="conversation-list">
            {% for conv in conversations %}
                <a href="{{ url_for('employer_views.chat_with_user', user_id=conv.user.user_id, job_id=conv.job_id) }}"
                   class="conversation-card"
                   data-conversation-id="{{ conv.user.user_id }}_{{ conv.job_id }}">
                    <img src="{{ conv.user.profile_picture_url or url_for('static', filename='images/default_profile.png') }}"
                         alt="Profile Picture"
                         class="profile-picture">

                    <div class="conversation-info">
                        <div class="conversation-header">
                            <div>
                                <div class="user-name">{{ conv.user.first_name }} {{ conv.user.last_name }}</div>
                                <div class="job-title">{{ conv.job_title }}</div>
                            </div>
                            <span class="timestamp" data-timestamp="{{ conv.latest_message.timestamp }}">
                                {{ conv.latest_message.timestamp }}
                            </span>
                        </div>
                        <div class="latest-message">{{ conv.latest_message.content }}</div>
                    </div>

                    {% if conv.unread_count > 0 %}
                        <span class="unread-badge">{{ conv.unread_count }}</span>
                    {% endif %}
                </a>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-conversations">
            <h3>No Messages</h3>
            <p>You haven't started any conversations yet.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update all timestamps on page load
    document.addEventListener('DOMContentLoaded', function() {
        const timestamps = document.querySelectorAll('.timestamp');
        timestamps.forEach(element => {
            const timestamp = element.getAttribute('data-timestamp');
            element.textContent = formatTimestamp(timestamp);
        });
    });

function formatTimestamp(isoTimestamp) {
    const now = new Date();
    const timestamp = new Date(isoTimestamp);  // Parse the ISO timestamp
    const diffInMilliseconds = now - timestamp;
    const diffInSeconds = Math.floor(diffInMilliseconds / 1000);

    // For debugging
    console.log('Now:', now);
    console.log('Timestamp:', timestamp);
    console.log('Difference in seconds:', diffInSeconds);

    // If invalid date, return original string
    if (isNaN(timestamp.getTime())) {
        console.log('Invalid timestamp');
        return isoTimestamp;
    }

    // Less than 1 minute ago
    if (diffInSeconds < 60) {
        return 'Just now';
    }

    // Less than 1 hour ago
    if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} ${minutes === 1 ? 'minute' : 'minutes'} ago`;
    }

    // Less than 24 hours ago
    if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
    }

    // More than 24 hours ago - show date
    const options = {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    };

    // Only show year if it's not the current year
    if (timestamp.getFullYear() !== now.getFullYear()) {
        options.year = 'numeric';
    }

    return timestamp.toLocaleString('en-US', options);
}

let eventSource;

function connectToMessageStream() {
    if (eventSource) {
        eventSource.close();
    }

    eventSource = new EventSource('/employer/messages/stream');

    eventSource.onmessage = function(event) {
        try {
            const message = JSON.parse(event.data);

            if (message.error) {
                console.error('Stream error:', message.error);
                return;
            }

            updateConversationList(message);

        } catch (error) {
            console.error('Error processing message:', error);
        }
    };

    eventSource.onerror = function(error) {
        console.error('EventSource failed:', error);
        eventSource.close();
        setTimeout(connectToMessageStream, 5000);
    };
}

function updateConversationList(message) {
    try {
        const conversationCard = document.querySelector(`[data-conversation-id="${message.conversation_id}"]`);

        if (conversationCard) {
            // Update existing conversation
            const latestMessageElement = conversationCard.querySelector('.latest-message');
            const timestampElement = conversationCard.querySelector('.timestamp');

            // Update the latest message content and timestamp
            latestMessageElement.textContent = message.content;
            timestampElement.setAttribute('data-timestamp', message.timestamp);
            timestampElement.textContent = formatTimestamp(message.timestamp);

            // Update unread count
            const unreadBadge = conversationCard.querySelector('.unread-badge');
            if (unreadBadge) {
                const currentCount = parseInt(unreadBadge.textContent);
                unreadBadge.textContent = currentCount + 1;
            } else {
                // Add new unread badge if it doesn't exist
                const badge = document.createElement('span');
                badge.className = 'unread-badge';
                badge.textContent = '1';
                conversationCard.appendChild(badge);
            }

            // Move conversation to top of the list
            const conversationList = conversationCard.parentElement;
            conversationList.insertBefore(conversationCard, conversationList.firstChild);
        } else {
            // Handle new conversation by reloading the page
            location.reload();
        }
    } catch (error) {
        console.error('Error updating conversation list:', error);
    }
}


document.addEventListener('DOMContentLoaded', connectToMessageStream);

window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});
</script>
{% endblock %}