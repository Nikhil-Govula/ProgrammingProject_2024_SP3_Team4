{% extends "base.html" %}

{% block head %}
    <title>Create Job Posting</title>
    <style>
        .ui-autocomplete {
            z-index: 1000;
            background-color: white;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
        }
        .ui-menu-item {
            padding: 5px;
            cursor: pointer;
        }
        .dynamic-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .dynamic-input-group input {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .dynamic-input-group select {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .remove-input-button {
            padding: 8px 12px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .remove-input-button:hover {
            background-color: #c0392b;
        }
        .add-input-button {
            padding: 8px 12px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }
        .add-input-button:hover {
            background-color: #27ae60;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .notification.success {
            background-color: #2ecc71;
        }
        .notification.error {
            background-color: #e74c3c;
        }
    </style>
    <script>
        $(document).ready(function() {
            // Initialize autocomplete for City
            $('#city').autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "{{ url_for('user_views.city_suggestions') }}",
                        type: 'GET',
                        data: { query: request.term },
                        success: function(data) {
                            response($.map(data.suggestions, function(item) {
                                return {
                                    label: item.city + ', ' + item.country,
                                    value: item.city + ', ' + item.country
                                };
                            }));
                        },
                        error: function(xhr, status, error) {
                            console.error("Error fetching city suggestions:", error);
                            response([]);
                        }
                    });
                },
                minLength: 3,
                select: function(event, ui) {
                    console.log("Selected city: " + ui.item.value);
                }
            });

            // Initialize autocomplete for Certifications
            function initializeCertificationsAutocomplete() {
                $('.certification-input').autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: "{{ url_for('user_views.certification_suggestions') }}",
                            type: 'GET',
                            data: { query: request.term },
                            success: function(data) {
                                response($.map(data.suggestions, function(item) {
                                    return {
                                        label: item, // Assuming item is a string
                                        value: item
                                    };
                                }));
                            },
                            error: function(xhr, status, error) {
                                console.error("Error fetching certification suggestions:", error);
                                response([]);
                            }
                        });
                    },
                    minLength: 2,
                    select: function(event, ui) {
                        console.log("Selected certification: " + ui.item.value);
                    }
                });
            }

            // Initialize autocomplete for Skills
            function initializeSkillsAutocomplete() {
                $('.skill-input').autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: "{{ url_for('user_views.skill_suggestions') }}",
                            type: 'GET',
                            data: { query: request.term },
                            success: function(data) {
                                response($.map(data.suggestions, function(item) {
                                    return {
                                        label: item, // Assuming item is a string
                                        value: item
                                    };
                                }));
                            },
                            error: function(xhr, status, error) {
                                console.error("Error fetching skill suggestions:", error);
                                response([]);
                            }
                        });
                    },
                    minLength: 2,
                    select: function(event, ui) {
                        console.log("Selected skill: " + ui.item.value);
                    }
                });
            }

            // Initialize autocomplete for Occupation
            function initializeOccupationAutocomplete() {
                $('.occupation-input').autocomplete({
                    source: function(request, response) {
                        $.ajax({
                            url: "{{ url_for('user_views.get_occupation_suggestions') }}",
                            type: 'GET',
                            data: { query: request.term },
                            success: function(data) {
                                response($.map(data.suggestions, function(item) {
                                    return {
                                        label: item, // Assuming item is a string
                                        value: item
                                    };
                                }));
                            },
                            error: function(xhr, status, error) {
                                console.error("Error fetching occupation suggestions:", error);
                                response([]);
                            }
                        });
                    },
                    minLength: 2,
                    select: function(event, ui) {
                        console.log("Selected occupation: " + ui.item.value);
                    }
                });
            }

            // Initialize autocompletes
            initializeCertificationsAutocomplete();
            initializeSkillsAutocomplete();
            initializeOccupationAutocomplete();

            // Function to add a new certification input
            $('#add-certification').on('click', function(e) {
                e.preventDefault();
                var certificationInput = `
                    <div class="dynamic-input-group">
                        <input type="text" name="certifications[]" class="certification-input" placeholder="Add a certification" required>
                        <button type="button" class="remove-input-button">Remove</button>
                    </div>
                `;
                $('#certifications-container').append(certificationInput);
                initializeCertificationsAutocomplete();
            });

            // Function to add a new skill input
            $('#add-skill').on('click', function(e) {
                e.preventDefault();
                var skillInput = `
                    <div class="dynamic-input-group">
                        <input type="text" name="skills[]" class="skill-input" placeholder="Add a skill" required>
                        <button type="button" class="remove-input-button">Remove</button>
                    </div>
                `;
                $('#skills-container').append(skillInput);
                initializeSkillsAutocomplete();
            });

            // Function to add a new work history entry
            $('#add-work-history').on('click', function(e) {
                e.preventDefault();
                var workHistoryEntry = `
                    <div class="dynamic-input-group">
                        <input type="text" name="work_history[occupations][]" class="occupation-input" placeholder="Occupation" required>
                        <input type="number" name="work_history[durations][]" class="duration-input" placeholder="Duration (months)" min="1" required>
                        <button type="button" class="remove-input-button">Remove</button>
                    </div>
                `;
                $('#work-history-container').append(workHistoryEntry);
                initializeOccupationAutocomplete();
            });

            // Function to remove an input field
            $(document).on('click', '.remove-input-button', function() {
                $(this).parent('.dynamic-input-group').remove();
            });

            // Handle form submission to ensure multiple certifications, skills, and work history are captured
            $('#create-job-form').on('submit', function(e) {
                // Prevent default form submission
                e.preventDefault();

                // Gather form data
                var formData = $(this).serializeArray();
                var data = {};
                $.each(formData, function(index, field) {
                    if (field.name.includes('work_history')) {
                        // Handle nested work_history fields
                        var match = field.name.match(/work_history\[(occupations|durations)\]\[\]/);
                        if (match) {
                            var key = match[1];
                            if (!data['work_history']) {
                                data['work_history'] = [];
                            }
                            var lastIndex = data['work_history'].length - 1;
                            if (data['work_history'][lastIndex] && !data['work_history'][lastIndex][key]) {
                                data['work_history'][lastIndex][key] = field.value;
                            } else {
                                data['work_history'].push({ [key]: field.value });
                            }
                        }
                    } else {
                        var fieldName = field.name.replace(/\[\]$/, '');
                        if (data[fieldName]) {
                            if (Array.isArray(data[fieldName])) {
                                data[fieldName].push(field.value);
                            } else {
                                data[fieldName] = [data[fieldName], field.value];
                            }
                        } else {
                            data[fieldName] = field.value;
                        }
                    }
                });

                // Process work_history to merge occupation and duration
                if (data.work_history) {
                    var mergedWorkHistory = [];
                    var occupations = [];
                    var durations = [];
                    // Separate occupations and durations
                    $.each(data.work_history, function(index, entry) {
                        if (entry.occupations) {
                            occupations.push(entry.occupations);
                        }
                        if (entry.durations) {
                            durations.push(entry.durations);
                        }
                    });
                    // Merge them
                    for (var i = 0; i < occupations.length; i++) {
                        mergedWorkHistory.push({
                            occupation: occupations[i],
                            duration: parseInt(durations[i], 10)
                        });
                    }
                    data.work_history = mergedWorkHistory;
                }

                console.log("Form Data to be sent:", data);

                // Submit the form via AJAX
                $.ajax({
                    url: "{{ url_for('employer_views.create_job') }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        // Redirect on success
                        window.location.href = "{{ url_for('employer_views.view_jobs') }}";
                    },
                    error: function(xhr, status, error) {
                        console.error("Error creating job:", error);
                        alert("An error occurred while creating the job. Please try again.");
                    }
                });
            });
        });
    </script>
{% endblock %}

{% block body %}
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
<div class="content">
    <h2>Create Job Posting</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="notification {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <form id="create-job-form" method="POST">
        <!-- Job Title -->
        <div class="form-group">
            <label for="job_title">Job Title</label>
            <div class="dynamic-input-group">
                <input type="text" name="job_title" id="job_title" required>
            </div>
        </div>

        <!-- Job Description -->
        <div class="form-group">
            <label for="description">Job Description</label>
            <div class="dynamic-input-group">
                <textarea name="description" id="description" required></textarea>
            </div>
        </div>

        <!-- Requirements -->
        <div class="form-group">
            <label for="requirements">Requirements</label>
            <div class="dynamic-input-group">
                <textarea name="requirements" id="requirements" required></textarea>
            </div>
        </div>

        <!-- Salary -->
        <div class="form-group">
            <label for="salary">Salary</label>
            <div class="dynamic-input-group">
                <input type="number" name="salary" id="salary" required>
            </div>
        </div>

        <!-- City Field with Autocomplete -->
        <div class="form-group">
            <label for="city">City</label>
            <div class="dynamic-input-group">
                <input type="text" name="city" id="city" required>
            </div>
        </div>

        <!-- Certifications Field with Multiple Inputs -->
        <div class="form-group">
            <label>Certifications (Add multiple as needed)</label>
            <div id="certifications-container">
                <div class="dynamic-input-group">
                    <input type="text" name="certifications[]" class="certification-input" placeholder="Add a certification" required>
                    <button type="button" class="remove-input-button">Remove</button>
                </div>
            </div>
            <button type="button" id="add-certification" class="add-input-button">Add Certification</button>
        </div>

        <!-- Skills Field with Multiple Inputs -->
        <div class="form-group">
            <label>Skills (Add multiple as needed)</label>
            <div id="skills-container">
                <div class="dynamic-input-group">
                    <input type="text" name="skills[]" class="skill-input" placeholder="Add a skill" required>
                    <button type="button" class="remove-input-button">Remove</button>
                </div>
            </div>
            <button type="button" id="add-skill" class="add-input-button">Add Skill</button>
        </div>

        <!-- Work History Field with Multiple Inputs -->
        <div class="form-group">
            <label>Required Work History (Add multiple as needed)</label>
            <div id="work-history-container">
                <div class="dynamic-input-group">
                    <input type="text" name="work_history[occupations][]" class="occupation-input" placeholder="Occupation" required>
                    <input type="number" name="work_history[durations][]" class="duration-input" placeholder="Duration (months)" min="1" required>
                    <button type="button" class="remove-input-button">Remove</button>
                </div>
            </div>
            <button type="button" id="add-work-history" class="add-input-button">Add Work History</button>
        </div>

        <button type="submit" class="register-button">Post Job</button>
    </form>
</div>
{% endblock %}

{% block footer %}
    {{ super() }}
{% endblock %}
