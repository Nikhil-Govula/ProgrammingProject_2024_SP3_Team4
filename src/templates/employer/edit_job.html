{% extends "base.html" %}

{% block head %}
    <title>Edit Job Posting</title>
    <style>
        .ui-autocomplete {
            z-index: 1000;
            background-color: white;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
        }
        .ui-menu-item {
            padding: 5px;
            cursor: pointer;
        }
        .dynamic-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .dynamic-input-group input, .dynamic-input-group textarea {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .update-field-button {
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .update-field-button:hover {
            background-color: #2980b9;
        }
        .remove-input-button {
            padding: 8px 12px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .remove-input-button:hover {
            background-color: #c0392b;
        }
        .add-input-button {
            padding: 8px 12px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }
        .add-input-button:hover {
            background-color: #27ae60;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .notification.success {
            background-color: #2ecc71;
        }
        .notification.error {
            background-color: #e74c3c;
        }
    </style>
    <script>
        $(document).ready(function() {
            // Initialize autocomplete for City
            $('#city').autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "{{ url_for('user_views.city_suggestions') }}",
                        type: 'GET',
                        data: {query: request.term},
                        success: function (data) {
                            response($.map(data.suggestions, function (item) {
                                return {
                                    label: item.city + ', ' + item.country,
                                    value: item.city + ', ' + item.country
                                };
                            }));
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching city suggestions:", error);
                            response([]);
                        }
                    });
                },
                minLength: 3,
                select: function (event, ui) {
                    console.log("Selected city: " + ui.item.value);
                }
            });

            // Initialize autocomplete for Certifications
            $('#certification-input').autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "{{ url_for('user_views.certification_suggestions') }}",
                        type: 'GET',
                        data: {query: request.term},
                        success: function (data) {
                            response($.map(data.suggestions, function (item) {
                                return {
                                    label: item,
                                    value: item
                                };
                            }));
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching certification suggestions:", error);
                            response([]);
                        }
                    });
                },
                minLength: 2,
                select: function (event, ui) {
                    console.log("Selected certification: " + ui.item.value);
                }
            });

            // Initialize autocomplete for Skills
            $('#skill-input').autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "{{ url_for('user_views.skill_suggestions') }}",
                        type: 'GET',
                        data: {query: request.term},
                        success: function (data) {
                            response($.map(data.suggestions, function (item) {
                                return {
                                    label: item,
                                    value: item
                                };
                            }));
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching skill suggestions:", error);
                            response([]);
                        }
                    });
                },
                minLength: 2,
                select: function (event, ui) {
                    console.log("Selected skill: " + ui.item.value);
                }
            });

            // Initialize autocomplete for Occupation
            $('#occupation-input').autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: "{{ url_for('user_views.get_occupation_suggestions') }}",
                        type: 'GET',
                        data: {query: request.term},
                        success: function (data) {
                            response($.map(data.suggestions, function (item) {
                                return {
                                    label: item,  // Adjust based on API response structure
                                    value: item
                                };
                            }));
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching occupation suggestions:", error);
                            response([]);
                        }
                    });
                },
                minLength: 2,
                select: function (event, ui) {
                    console.log("Selected occupation: " + ui.item.value);
                }
            });

            // Handle adding a new certification
            $('#add-certification-button').on('click', function (e) {
                e.preventDefault();
                var certification = $('#certification-input').val().trim();

                if (certification === "") {
                    showNotification('Certification cannot be empty.', 'error');
                    return;
                }

                $.ajax({
                    url: "{{ url_for('employer_views.add_job_certification', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({certification: certification}),
                    success: function (response) {
                        if (response.success) {
                            // Sanitize certification string for use in HTML IDs
                            var safeCertification = certification.replace(/[^a-zA-Z0-9-_]/g, '');
                            $('#certifications-list').append(`
                                <li id="certification-${safeCertification}">
                                    ${certification}
                                    <button type="button" class="delete-certification-button" data-certification="${certification}">Delete</button>
                                </li>
                            `);
                            $('#certification-input').val('');
                            $('#no-certifications-message').hide();
                            showNotification('Certification added successfully.', 'success');
                        } else {
                            showNotification(response.message, 'error');
                        }
                    },
                    error: function () {
                        showNotification('An error occurred while adding the certification.', 'error');
                    }
                });
            });

            // Handle deleting a certification
            $(document).on('click', '.delete-certification-button', function () {
                var certification = $(this).data('certification');
                var $listItem = $(this).closest('li');

                $.ajax({
                    url: "{{ url_for('employer_views.delete_job_certification', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({certification: certification}),
                    success: function (response) {
                        if (response.success) {
                            $listItem.remove();
                            if ($('#certifications-list li').length === 0) {
                                $('#no-certifications-message').show();
                            }
                            showNotification('Certification deleted successfully.', 'success');
                        } else {
                            showNotification(response.message || 'Failed to delete certification.', 'error');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Error deleting certification:", textStatus, errorThrown);
                        showNotification('An error occurred while deleting the certification.', 'error');
                    }
                });
            });

            // Handle skill deletion
            $(document).on('click', '.delete-skill-button', function () {
                var skill = $(this).data('skill');
                var $listItem = $(this).closest('li');

                $.ajax({
                    url: "{{ url_for('employer_views.delete_job_skill', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({skill: skill}),
                    success: function (response) {
                        if (response.success) {
                            $listItem.remove();
                            if ($('#skills-list li').length === 0) {
                                $('#no-skills-message').show();
                            }
                            showNotification('Skill deleted successfully.', 'success');
                        } else {
                            showNotification(response.message || 'Failed to delete skill.', 'error');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Error deleting skill:", textStatus, errorThrown);
                        showNotification('An error occurred while deleting the skill.', 'error');
                    }
                });
            });

            // Handle adding a new skill
            $('#add-skill-button').on('click', function (e) {
                e.preventDefault();
                var skill = $('#skill-input').val().trim();

                if (skill === "") {
                    showNotification('Skill cannot be empty.', 'error');
                    return;
                }

                $.ajax({
                    url: "{{ url_for('employer_views.add_job_skill', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({skill: skill}),
                    success: function (response) {
                        if (response.success) {
                            // Sanitize skill string for use in HTML IDs
                            var safeSkill = skill.replace(/[^a-zA-Z0-9-_]/g, '');
                            $('#skills-list').append(`
                                <li id="skill-${safeSkill}">
                                    ${skill}
                                    <button type="button" class="delete-skill-button" data-skill="${skill}">Delete</button>
                                </li>
                            `);
                            $('#skill-input').val('');
                            $('#no-skills-message').hide();
                            showNotification(response.message, 'success');
                        } else {
                            showNotification(response.message, 'error');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Use the message from the server's response
                        var errorMessage = jqXHR.responseJSON && jqXHR.responseJSON.message
                            ? jqXHR.responseJSON.message
                            : 'An error occurred while adding the skill.';
                        console.error("Error adding skill:", errorMessage);
                        showNotification(errorMessage, 'error');
                    }
                });
            });

            // Handle adding a new work history entry
            $('#add-work-history-button').on('click', function (e) {
                e.preventDefault();
                var occupation = $('#occupation-input').val().trim();
                var duration = $('#duration-input').val().trim();

                if (occupation === "" || duration === "") {
                    showNotification('Occupation and duration cannot be empty.', 'error');
                    return;
                }

                if (!/^\d+$/.test(duration) || parseInt(duration) <= 0) {
                    showNotification('Duration must be a positive integer representing months.', 'error');
                    return;
                }

                $.ajax({
                    url: "{{ url_for('employer_views.add_work_history', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({occupation: occupation, duration: duration}),
                    success: function (response) {
                        if (response.success) {
                            // Sanitize occupation string for use in HTML IDs
                            var safeOccupation = occupation.replace(/[^a-zA-Z0-9-_]/g, '');
                            var safeDuration = duration.replace(/[^a-zA-Z0-9-_]/g, '');
                            $('#work-history-list').append(`
                                <li id="work-history-${safeOccupation}-${safeDuration}">
                                    <strong>${occupation}</strong> - ${duration} month(s)
                                    <button type="button" class="delete-work-history-button" data-occupation="${occupation}" data-duration="${duration}">Delete</button>
                                </li>
                            `);
                            $('#occupation-input').val('');
                            $('#duration-input').val('');
                            $('#no-work-history-message').hide();
                            showNotification('Work history entry added successfully.', 'success');
                        } else {
                            showNotification(response.message, 'error');
                        }
                    },
                    error: function () {
                        showNotification('An error occurred while adding the work history entry.', 'error');
                    }
                });
            });

            // Handle deleting a work history entry
            $(document).on('click', '.delete-work-history-button', function () {
                var occupation = $(this).data('occupation');
                var duration = $(this).data('duration');
                var $listItem = $(this).closest('li');

                $.ajax({
                    url: "{{ url_for('employer_views.delete_work_history', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({occupation: occupation, duration: duration}),
                    success: function (response) {
                        if (response.success) {
                            $listItem.remove();
                            if ($('#work-history-list li').length === 0) {
                                $('#no-work-history-message').show();
                            }
                            showNotification('Work history entry deleted successfully.', 'success');
                        } else {
                            showNotification(response.message || 'Failed to delete work history entry.', 'error');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Error deleting work history entry:", textStatus, errorThrown);
                        showNotification('An error occurred while deleting the work history entry.', 'error');
                    }
                });
            });

            // Handle updating individual fields
            $('.update-field-button').on('click', function(e) {
                e.preventDefault();
                var field = $(this).data('field');
                var value;

                // Determine the type of input (input or textarea)
                if ($('#' + field).is('textarea')) {
                    value = $('#' + field).val().trim();
                } else {
                    value = $('#' + field).val().trim();
                }

                if(value === "") {
                    showNotification(`${field.replace('_', ' ').capitalize()} cannot be empty.`, 'error');
                    return;
                }

                // Additional validation for the 'city' field
                if(field === 'city') {
                    if(!value.includes(',')) {
                        showNotification("Please enter both city and country, separated by a comma.", 'error');
                        return;
                    }
                    var parts = value.split(',');
                    if(parts.length !== 2 || !parts[0].trim() || !parts[1].trim()) {
                        showNotification("Please ensure both city and country are provided.", 'error');
                        return;
                    }
                }

                var data = {};
                data[field] = value;

                $.ajax({
                    url: "{{ url_for('employer_views.edit_job', job_id=job.job_id) }}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        if(response.success) {
                            showNotification(`${field.replace('_', ' ').capitalize()} updated successfully.`, 'success');
                        } else {
                            showNotification("Error: " + response.message, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error(`Error updating ${field}:`, error);
                        showNotification(`An error occurred while updating ${field.replace('_', ' ')}. Please try again.`, 'error');
                    }
                });
            });

            // Handle job deletion
            $('#delete-job-button').on('click', function() {
                if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                    $.ajax({
                        url: "{{ url_for('employer_views.delete_job', job_id=job.job_id) }}",
                        type: 'POST',
                        success: function(response) {
                            if (response.success) {
                                showNotification('Job deleted successfully.', 'success');
                                // Redirect to the jobs list page after a short delay
                                setTimeout(function() {
                                    window.location.href = "{{ url_for('employer_views.view_jobs') }}";
                                }, 2000);
                            } else {
                                showNotification(response.message || 'Failed to delete job.', 'error');
                            }
                        },
                        error: function() {
                            showNotification('An error occurred while deleting the job.', 'error');
                        }
                    });
                }
            });

            // Notification Function
            function showNotification(message, type = 'success') {
                const notificationContainer = $('#notification-container');
                // Clear any existing notifications
                notificationContainer.empty();

                const notification = $(`
                    <div class="notification ${type}">
                        ${message}
                    </div>
                `);
                notificationContainer.append(notification);

                // Trigger a reflow before adding the opacity to ensure the transition works
                notification[0].offsetHeight;
                notification.css('opacity', '1');

                setTimeout(() => {
                    notification.css('opacity', '0');
                    setTimeout(() => {
                        notification.remove();
                    }, 500); // Wait for fade out transition to complete before removing
                }, 3000); // Show for 3 seconds
            }

            // Capitalize function for better message formatting
            String.prototype.capitalize = function () {
                return this.charAt(0).toUpperCase() + this.slice(1);
            }
        });
    </script>
{% endblock %}

{% block body %}
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
<div class="content">
    <h2>Edit Job Posting</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="notification {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <form id="edit-job-form" method="POST">
        <!-- Job Title -->
        <div class="form-group">
            <label for="job_title">Job Title</label>
            <div class="dynamic-input-group">
                <input type="text" name="job_title" id="job_title" value="{{ job.job_title }}" required>
                <button type="button" class="update-field-button" data-field="job_title">Update</button>
            </div>
        </div>

        <!-- Job Description -->
        <div class="form-group">
            <label for="description">Job Description</label>
            <div class="dynamic-input-group">
                <textarea name="description" id="description" required>{{ job.description }}</textarea>
                <button type="button" class="update-field-button" data-field="description">Update</button>
            </div>
        </div>

        <!-- Requirements -->
        <div class="form-group">
            <label for="requirements">Requirements</label>
            <div class="dynamic-input-group">
                <textarea name="requirements" id="requirements" required>{{ job.requirements }}</textarea>
                <button type="button" class="update-field-button" data-field="requirements">Update</button>
            </div>
        </div>

        <!-- Salary -->
        <div class="form-group">
            <label for="salary">Salary</label>
            <div class="dynamic-input-group">
                <input type="number" name="salary" id="salary" value="{{ job.salary }}" required>
                <button type="button" class="update-field-button" data-field="salary">Update</button>
            </div>
        </div>

        <!-- City -->
        <div class="form-group">
            <label for="city">City</label>
            <div class="dynamic-input-group">
                <input type="text" name="city" id="city" value="{{ job.city }}, {{ job.country }}" placeholder="e.g., Perth, Australia" required>
                <button type="button" class="update-field-button" data-field="city">Update</button>
            </div>
        </div>

        <!-- Certifications Section -->
        <div class="form-group">
            <h3>Certifications</h3>
            <div>
                <label for="certification-input">Add a Certification:</label><br>
                <input type="text" id="certification-input" name="certification" placeholder="e.g., AWS Certified Solutions Architect" required>
                <button type="button" id="add-certification-button" class="add-input-button">Add Certification</button>
            </div>
        </div>

        <!-- Existing Certifications -->
        <div class="form-group">
            <label>Existing Certifications:</label>
            {% if job.certifications %}
                <ul id="certifications-list">
                    {% for cert in job.certifications %}
                        <li id="certification-{{ cert | replace(' ', '_') }}">
                            {{ cert }}
                            <button type="button" class="delete-certification-button" data-certification="{{ cert }}">Delete</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p id="no-certifications-message">No certifications added.</p>
            {% endif %}
        </div>

        <!-- Skills Section -->
        <div class="form-group">
            <h3>Skills</h3>
            <div>
                <label for="skill-input">Add a Skill:</label><br>
                <input type="text" id="skill-input" name="skill" placeholder="e.g., Python" required>
                <button type="button" id="add-skill-button" class="add-input-button">Add Skill</button>
            </div>
        </div>

        <!-- Existing Skills -->
        <div class="form-group">
            <label>Existing Skills:</label>
            {% if job.skills %}
                <ul id="skills-list">
                    {% for skill in job.skills %}
                        <li id="skill-{{ skill | replace(' ', '_') }}">
                            {{ skill }}
                            <button type="button" class="delete-skill-button" data-skill="{{ skill }}">Delete</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p id="no-skills-message">No skills added.</p>
            {% endif %}
        </div>

        <!-- Required Work History Section -->
        <div class="form-group">
            <h3>Required Work History</h3>
            <div>
                <label for="occupation-input">Occupation:</label><br>
                <input type="text" id="occupation-input" name="occupation" placeholder="e.g., Software Engineer" required>
                <label for="duration-input">Duration (months):</label><br>
                <input type="number" id="duration-input" name="duration" placeholder="e.g., 24" required>
                <button type="button" id="add-work-history-button" class="add-input-button">Add Work History</button>
            </div>
        </div>

        <!-- Existing Work History -->
        <div class="form-group">
            <label>Existing Work History:</label>
            {% if job.work_history %}
                <ul id="work-history-list">
                    {% for entry in job.work_history %}
                        <li id="work-history-{{ entry.occupation | replace(' ', '_') }}-{{ entry.duration }}">
                            <strong>{{ entry.occupation }}</strong> - {{ entry.duration }} month(s)
                            <button type="button" class="delete-work-history-button" data-occupation="{{ entry.occupation }}" data-duration="{{ entry.duration }}">Delete</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p id="no-work-history-message">No work history entries added.</p>
            {% endif %}
        </div>

        <div class="form-group">
            <button type="button" id="delete-job-button" class="btn btn-danger">Delete Job</button>
        </div>
    </form>
</div>
{% endblock %}

{% block footer %}
    {{ super() }}
{% endblock %}
