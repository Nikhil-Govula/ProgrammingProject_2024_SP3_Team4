{% extends "base.html" %}

{% block head %}
    <style>
        .accounts-table {
            width: 100%;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.5em 1em;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1em;
        }

        .dataTables_wrapper .dataTables_scrollHead {
            background-color: #4CAF50;
        }

        .selected {
            background-color: #d9edf7 !important;
        }

        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
    </style>
{% endblock %}

{% block body %}
<div class="view-jobs-page">
    <div class="job-page-header">
        <div>
            <a href="{{ url_for('employer_views.create_job') }}" class="btn">Create New Job</a>
            <button id="editSelectedJob" class="btn btn-edit-disabled" disabled>Edit Selected Job</button>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="notification {{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Job Table -->
    <table class="display responsive nowrap accounts-table" id="jobsTable">
        <thead>
            <tr>
                <th>Job Title</th>
                <th>Description</th>
                <th>Salary</th>
                <th>City</th>
                <th>Country</th>
                <th>Date Posted</th>
            </tr>
        </thead>
        <tbody>
        {% for job in jobs %}
            <tr data-job-id="{{ job.job_id }}">
                <td>{{ job.job_title }}</td>
                <td>{{ job.description }}</td>
                <td>${{ "{:,.2f}".format(job.salary) }}</td>
                <td>{{ job.city }}</td>
                <td>{{ job.country }}</td>
                <!-- Slice the date string to display only YYYY-MM-DD -->
                <td>{{ job.date_posted[:10] if job.date_posted else '' }}</td>
            </tr>
        {% else %}
            <tr>
                <td colspan="6">No job postings found.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- DataTables Initialization and Other Scripts -->
<script>
    $(document).ready(function() {
        let selectedJobId = null;

        // Initialize DataTables with responsive option
        var table = $('#jobsTable').DataTable({
            "paging": true,
            "searching": true,
            "info": false,
            "lengthChange": false,
            "pageLength": 10,
            "autoWidth": true,
            "responsive": true,
            "columns": [
                { "width": "20%", "responsivePriority": 1 },
                { "width": "40%", "responsivePriority": 2 },
                { "width": "10%", "responsivePriority": 3 },
                { "width": "10%", "responsivePriority": 4 },
                { "width": "10%", "responsivePriority": 5 },
                { "width": "10%", "responsivePriority": 6 }
            ]
        });

        $(window).on('resize', function () {
            table.columns.adjust().draw();
        });

        // Handle row selection
        $('#jobsTable tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
                selectedJobId = null;
                $('#editSelectedJob').addClass('btn-edit-disabled').prop('disabled', true);
            } else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                selectedJobId = $(this).data('job-id');
                $('#editSelectedJob').removeClass('btn-edit-disabled').prop('disabled', false);
            }
        });

        // Handle edit button click
        $('#editSelectedJob').click(function() {
            if (selectedJobId) {
                // Redirect to the edit page for the selected job
                window.location.href = `/employer/jobs/edit/${selectedJobId}`;
            }
        });
    });

    // Flash Message Fade Out
    window.onload = function() {
        var notifications = document.querySelectorAll('.notification');
        notifications.forEach(function(notification) {
            setTimeout(function() {
                notification.classList.add('fade-out');
            }, 3000); // 3 seconds
        });
    };
</script>
{% endblock %}